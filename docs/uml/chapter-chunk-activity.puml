@startuml
title Chapter Split + Chunk Planning Activity

start
:Input cleaned text + source PDF + chunk_size_chars;

if (Text empty?) then (yes)
  :Return [] chapters and [] chunks;
  stop
else (no)
endif

:Try PdfOutlineChapterExtractor.extract(source_pdf);
if (Outline chapters available?) then (yes)
  :Use outline chapters;
  :chapter_source = "pdf_outline";
else (no)
  :Fallback ChapterSplitter.split(cleaned_text);
  :chapter_source = "text_heuristic";
endif

:Resolve selected chapters from chapter_selection;
:Build normalized structure units;
if (Outline structure available?) then (yes)
  :Use outline structure;
else (no)
  :ChapterStructureNormalizer.from_chapters(...);
endif

if (chunk_size_chars <= 0?) then (yes)
  :Return selected chapters and [] chunks;
  stop
else (no)
endif

if (Selected structure units exist?) then (yes)
  :TextBudgetSegmentPlanner.plan(units, budget);
  :Convert planned segments to chunks;
else (no)
  :Fallback Chunker.to_chunks(selected_chapters, budget);
  :Decorate chunks with deterministic part metadata;
endif

:SentenceBoundaryRepairer.repair(chunks, budget);
:Persist chunk metadata
(planner strategy, repairs count);
:Return deterministic chunk list;
stop

@enduml
